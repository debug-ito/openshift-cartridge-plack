#!/bin/bash

exit 0

LIB_DIR="${OPENSHIFT_PLACK_DIR}/local"
export PERL_CPANM_OPT="--quiet --notest -l $LIB_DIR"
export PATH="$LIB_DIR/bin:$PATH"

daemon_control() {
    local command="$1"
    "${OPENSHIFT_PLACK_DIR}/bin/daemon_control" "$command"
    exit $?
}

tidy() {
    echo "-----> Clean up logs in $OPENSHIFT_PLACK_LOG_DIR"
    shopt -s dotglob
    rm -vf "$OPENSHIFT_PLACK_LOG_DIR"/*
    echo "-----> Done"
}

build() {
    echo "-----> Installing dependency"
    cd "${OPENSHIFT_REPO_DIR}"
    if ! (cpanm --installdeps .); then
        exit 1
    fi
    echo "-----> Testing"
    if ! prove; then
        exit 1
    fi
    echo "-----> Done"
}

case "$1" in
    start|stop|restart|status|reload) daemon_control "$1" ;;
    tidy)    tidy ;;
    build)   build ;;
    *)       exit 0
esac
